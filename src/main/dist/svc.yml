name: {{FRAMEWORK_NAME}}
scheduler:
  principal: {{SERVICE_PRINCIPAL}}
  user: {{SERVICE_USER}}
pods:
  master:
    image: {{COLLECTOR_DOCKER_IMAGE}}
    count: 1
    tasks:
      exporter:
        goal: RUNNING
        cmd: /bin/mesos-exporter -master {{MASTER_ADDRESS}}
        cpus: {{MASTER_CPUS}}
        memory: {{MASTER_MEM}}
        ports:
          collector:
            port: 9105
            env-key: EXPORTER_PORT
  prometheus:
    count: 1
    uris:
      - {{PROMETHEUS_URI}}
      - {{BOOTSTRAP_URI}}
    tasks:
      server:
        goal: RUNNING
        cmd: ./bootstrap --resolve=false && prometheus-1.8.0.linux-amd64/prometheus -config.file=prometheus.yml -storage.local.path=$MESOS_SANDBOX/prometheus-storage
        env:
          SCRAPE_INTERVAL: {{SCRAPE_INTERVAL}}
          SCRAPE_TIMEOUT: {{SCRAPE_TIMEOUT}}
        configs:
          server-properties:
            template: prometheus.yml
            dest: prometheus.yml
        cpus: {{PROMETHEUS_CPUS}}
        memory: {{PROMETHEUS_MEM}}
        volume:
          path: prometheus-storage
          type: ROOT
          size: 25000
        ports:
          prometheus:
            port: 9090
            env-key: PROMETHEUS_PORT
            advertise: true
            vip:
              prefix: prometheus
              port: 9090
  grafana:
    pre-reserved-role: slave_public
    count: 1
    uris:
      - {{GRAFANA_URI}}
      - {{BOOTSTRAP_URI}}
    tasks:
      server:
        goal: RUNNING
        cmd: ./bootstrap --resolve=false && cd grafana-5.0.1 && bin/grafana-server web
        cpus: {{GRAFANA_CPUS}}
        memory: {{GRAFANA_MEM}}
        ports:
          grafana:
            port: {{GRAFANA_PORT}}
            env-key: GRAFANA_PORT
            advertise: true
        readiness-check:
          cmd: |
                  curl -f http://admin:admin@grafana-0-server.prometheus.mesos:{{GRAFANA_PORT}}/api/admin/settings
          interval: 5
          delay: 0
          timeout: 60
        configs:
          defaults:
            template: defaults.ini
            dest: grafana-5.0.1/conf/defaults.ini
      add-data-sources:
        goal: FINISHED
        cpus: 0.1
        memory: 32
        cmd: |
                curl -H "Content-Type: application/json" -X POST -d '{"name":"prometheus","type":"prometheus","url":"http://prometheus-0-server.prometheus.mesos:9090","access":"proxy","basicAuth":false, "isDefault":true}' http://admin:admin@grafana-0-server.prometheus.mesos:{{GRAFANA_PORT}}/api/datasources

plans:
  deploy:
    phases:
      prometheus:
        pod: prometheus
      master:
        pod: master
      grafana:
        pod: grafana
        steps:
          - default: [[server], [add-data-sources]]


